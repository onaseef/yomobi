/*!
* Aloha Editor
* Author & Copyright (c) 2010 Gentics Software GmbH
* aloha-sales@gentics.com - way to over-lawyer it up Andrew :/
* Licensed unter the terms of http://www.aloha-editor.com/license.html
*/
define(["aloha","aloha/jquery","aloha/plugin","aloha/pluginmanager","aloha/floatingmenu","i18n!table/nls/i18n","i18n!aloha/nls/i18n","table/table-create-layer","table/table","table/table-plugin-utils","css!table/css/table.css"],function(e,t,n,r,i,s,o,u,a,f){function p(){var e=[],n=h;return t.each(arguments,function(){e.push("."+(this==""?n:n+"-"+this))}),e.join(" ").trim()}function d(){var e=[],n=h;return t.each(arguments,function(){e.push(this==""?n:n+"-"+this)}),e.join(" ").trim()}function v(e,n){var r=e.endContainer,i=e.startContainer,s=r.nodeType==3?r.length:r.childNodes.length;i.nodeType==3&&i.parentNode.tagName=="P"&&i.parentNode.childNodes.length==1&&/^(\s|%A0)$/.test(escape(i.data))&&(i.data="",e.startOffset=0,r==i&&(e.endOffset=0)),l.Utils.Dom.allowsNesting(i.nodeType==3?i.parentNode:i,n)||(e.startOffset==0&&t(i.nodeType==3?i.parentNode:i).addClass("aloha-table-cleanme"),e.endOffset==s&&t(r.nodeType==3?r.parentNode:r).addClass("aloha-table-cleanme"))}function m(){var e=t(".aloha-table-cleanme").removeClass("aloha-table-cleanme");for(var n=0;n<e.length;n++)t.trim(t(e[n]).html())==""&&!l.Utils.Dom.isEditingHost(e[n])&&t(e[n]).remove()}var l=window.GENTICS,c=new n("table");c.createLayer=undefined,c.languages=["en","de","fr","eo","fi","ru","it","pl"],c.config=["table"],c.TableRegistry=new Array,c.activeTable=undefined,c.parameters={className:"aloha-table",classSelectionRow:"aloha-table-selectcolumn",classSelectionColumn:"aloha-table-selectrow",classLeftUpperCorner:"aloha-table-leftuppercorner",classTableWrapper:"aloha-table-wrapper",classCellSelected:"aloha-cell-selected",waiRed:"aloha-wai-red",waiGreen:"aloha-wai-green",selectionArea:10},c.checkConfig=function(e){if(typeof e=="object"&&e.length){var t=[];for(var n=0;n<e.length;n++)e[n]&&t.push({text:e[n].text?e[n].text:e[n].name,tooltip:e[n].tooltip?e[n].tooltip:e[n].text,iconClass:e[n].iconClass?e[n].iconClass:"aloha-button-"+e[n].name,cssClass:e[n].cssClass?e[n].cssClass:e[n].name});e=t}else e=[];return e},c.init=function(){this.tableConfig=this.checkConfig(this.tableConfig||this.settings.tableConfig),this.columnConfig=this.checkConfig(this.columnConfig||this.settings.columnConfig),this.rowConfig=this.checkConfig(this.rowConfig||this.settings.rowConfig),this.createLayer=new u(this);var n=this;e.bind("aloha-editable-created",function(e,t){t.obj.bind("mousedown",function(e){c.setFocusedTable(undefined)}),t.obj.find("table").each(function(){if(n.isEditableTable(this)&&!c.isWithinTable(this)){var e=new a(this,c);e.parentEditable=t,c.TableRegistry.push(e)}c.checkForNestedTables(t.obj)})}),this.initTableButtons(),e.bind("aloha-table-selection-changed",function(){null!=c.activeTable&&0!==c.activeTable.selection.selectedCells.length&&c.updateFloatingMenuScope(),typeof c.activeTable!="undefined"&&c.activeTable.selection&&(c.activeTable.selection.cellsAreSplitable()?(n.btnSplitcells.enable(),n.btnRowsplitcells.enable(),n.btnTablesplitcells.enable()):(n.btnSplitcells.disable(),n.btnRowsplitcells.disable(),n.btnTablesplitcells.disable()),c.activeTable.selection.cellsAreMergeable()?(n.btnMergecells.enable(),n.btnRowmergecells.enable(),n.btnTablemergecells.enable()):(n.btnMergecells.disable(),n.btnRowmergecells.disable(),n.btnTablemergecells.disable()))}),e.bind("aloha-selection-changed",function(r,s){if(null==s.startContainer)return;if(e.activeEditable){var o=n.getEditableConfig(e.activeEditable.obj);t.inArray("table",o)!=-1&&e.Selection.mayInsertTag("table")?n.createTableButton.show():n.createTableButton.hide();var u=s.findMarkup(function(){return this.nodeName.toLowerCase()=="table"},e.activeEditable.obj);n.activeTable&&(u?c.updateFloatingMenuScope():(n.activeTable.selection.cellSelectionMode=!1,n.activeTable.selection.baseCellPosition=null,n.activeTable.selection.lastSelectionRange=null,n.activeTable.focusOut())),i.doLayout()}}),e.bind("aloha-editable-activated",function(e,r){n.btnSplitcells.disable(),n.btnRowsplitcells.disable(),n.btnTablesplitcells.disable(),n.btnMergecells.disable(),n.btnRowmergecells.disable(),n.btnTablemergecells.disable(),r.editable.obj.find("table").each(function(){var e=c.TableRegistry;for(var i=0;i<e.length;i++)if(e[i].obj.attr("id")==t(this).attr("id"))return e[i].activate(),!0;if(n.isEditableTable(this)&&!c.isWithinTable(this)){var s=new a(this,c);s.parentEditable=r.editable,s.activate(),c.TableRegistry.push(s)}c.checkForNestedTables(r.editable.obj)})}),e.bind("aloha-editable-deactivated",function(e,t){c.activeTable&&c.activeTable.selection.unselectCells(),c.setFocusedTable(undefined);var n=c.TableRegistry;for(var r=0;r<n.length;r++)n[r].deactivate()}),e.bind("aloha-smart-content-changed",function(t){e.activeEditable&&e.activeEditable.obj.find("table").each(function(){if(c.indexOfTableInRegistry(this)==-1&&!c.isWithinTable(this)){this.id=l.Utils.guid();var t=new a(this,c);t.parentEditable=e.activeEditable,c.TableRegistry.push(t),t.activate()}c.checkForNestedTables(e.activeEditable.obj)})}),this.settings.summaryinsidebar&&e.ready(function(){n.initSidebar(e.Sidebar.right.show())})};var h="aloha-table";return c.initSidebar=function(e){var n=this;n.sidebar=e,e.addPanel({id:d("sidebar-panel"),title:s.t("table.sidebar.title"),content:"",expanded:!0,activeOn:"table",onInit:function(){var e=this,r=this.setContent('<label class="'+d("label")+'" for="'+d("textarea")+'" >'+s.t("table.label.target")+"</label>"+'<textarea id="'+d("textarea")+'" class="'+d("textarea")+'" />').content;t(p("textarea")).live("keyup",function(){t(e.effective).attr("summary",t(p("textarea")).val());var r=t('div[class*="wai"]',"table#"+t(e.effective).attr("id"));r.removeClass(n.get("waiGreen")),r.removeClass(n.get("waiRed")),t(p("textarea")).val().trim()!=""?r.addClass(n.get("waiGreen")):r.addClass(n.get("waiRed"))})},onActivate:function(e){var n=this;n.effective=e,t(p("textarea")).val(t(n.effective).attr("summary"))}}),e.show()},c.isEditableTable=function(e){return l.Utils.Dom.isEditable(e)},c.indexOfTableInRegistry=function(e){var t=this.TableRegistry;for(var n=0;n<t.length;n++)if(t[n].obj[0].id==e.id)return n;return-1},c.getTableFromRegistry=function(e){var t=this.indexOfTableInRegistry(e);return t>-1?this.TableRegistry[t]:null},c.isSelectionInTable=function(){var n=e.Selection.getRangeObject(),r=t(n.commonAncestorContainer);return r.length==0?!1:r.parents(".aloha-editable table").length?!0:!1},c.preventNestedTables=function(){return this.isSelectionInTable()?(e.showMessage(new e.Message({title:s.t("Table"),text:s.t("table.createTable.nestedTablesNoSupported"),type:e.Message.Type.ALERT})),!0):!1},c.isWithinTable=function(e){return t(e).parents(".aloha-editable table").length>0},c.checkForNestedTables=function(e){e.find("table table").length},c.initRowsBtns=function(){var n=this;i.addButton(this.name+".row",new e.ui.Button({name:"addrowbefore",iconClass:"aloha-button aloha-button-addRowBefore",size:"small",tooltip:s.t("button.addrowbefore.tooltip"),onclick:function(){n.activeTable&&n.activeTable.addRowBeforeSelection()}}),s.t("floatingmenu.tab.table"),1),i.addButton(this.name+".row",new e.ui.Button({name:"addrowafter",iconClass:"aloha-button aloha-button-addRowAfter",size:"small",tooltip:s.t("button.addrowafter.tooltip"),onclick:function(){n.activeTable&&n.activeTable.addRowAfterSelection()}}),s.t("floatingmenu.tab.table"),1),i.addButton(this.name+".row",new e.ui.Button({name:"deleterow",iconClass:"aloha-button aloha-button-deleteRows",size:"small",tooltip:s.t("button.delrows.tooltip"),onclick:function(){if(n.activeTable){var t=n.activeTable;e.showMessage(new e.Message({title:s.t("Table"),text:s.t("deleterows.confirm"),type:e.Message.Type.CONFIRM,callback:function(e){e=="yes"&&t.deleteRows()}}))}}}),s.t("floatingmenu.tab.table"),1),this.rowHeader=new e.ui.Button({name:"rowheader",iconClass:"aloha-button aloha-button-row-header",size:"small",tooltip:s.t("button.rowheader.tooltip"),toggle:!0,onclick:function(){if(n.activeTable){var r=n.activeTable.selection.selectedCells;n.rowsToSelect=[];var i=r[0]&&r[0].nodeName.toLowerCase()=="td"&&r.length==1||r[0]&&r[0].nodeName.toLowerCase()=="td"&&r[1].nodeName.toLowerCase()=="td";for(var s=0;s<r.length;s++)s==0&&n.rowsToSelect.push(r[s].rowIndex),i?r[s]=e.Markup.transformDomObject(r[s],"th").attr("scope","col")[0]:r[s]=e.Markup.transformDomObject(r[s],"td").removeAttr("scope")[0],t(r[s]).bind("mousedown",function(e){var r=t(this).children("div").eq(0);setTimeout(function(){r.trigger("focus")},1),n.activeTable&&n.activeTable.selection.unselectCells()});n.activeTable&&(n.activeTable.refresh(),n.activeTable.selectRows())}}}),i.addButton(this.name+".row",this.rowHeader,s.t("floatingmenu.tab.table"),1),this.btnRowmergecells=new e.ui.Button({name:"rowmergecells",iconClass:"aloha-button aloha-button-merge-cells",size:"small",tooltip:s.t("button.mergecells.tooltip"),toggle:!1,onclick:function(){n.activeTable&&n.activeTable.selection.mergeCells()}}),i.addButton(this.name+".row",this.btnRowmergecells,s.t("floatingmenu.tab.table"),1),this.btnRowsplitcells=new e.ui.Button({name:"rowsplitcells",iconClass:"aloha-button aloha-button-split-cells",size:"small",tooltip:s.t("button.splitcells.tooltip"),toggle:!1,onclick:function(){n.activeTable&&n.activeTable.selection.splitCells()}}),i.addButton(this.name+".row",this.btnRowsplitcells,s.t("floatingmenu.tab.table"),1),this.rowMSItems=[],t.each(this.rowConfig,function(e,r){n.rowMSItems.push({name:r.name,text:s.t(r.text),tooltip:s.t(r.tooltip),iconClass:"aloha-button aloha-row-layout "+r.iconClass,click:function(){if(n.activeTable){var e=n.activeTable.selection.selectedCells;for(var i=0;i<e.length;i++)if(t(e[i]).attr("class").indexOf(r.cssClass)>-1)t(e[i]).removeClass(r.cssClass);else{t(e[i]).addClass(r.cssClass);for(var s=0;s<n.rowConfig.length;s++)n.rowConfig[s].cssClass!=r.cssClass&&t(e[i]).removeClass(n.rowConfig[s].cssClass)}n.activeTable.selectRows()}}})}),this.rowMSItems.length>0&&this.rowMSItems.push({name:"removeFormat",text:s.t("button.removeFormat.text"),tooltip:s.t("button.removeFormat.tooltip"),iconClass:"aloha-button aloha-button-removeFormat",wide:!0,click:function(){if(n.activeTable){var e=n.activeTable.selection.selectedCells;for(var r=0;r<e.length;r++)for(var i=0;i<n.rowConfig.length;i++)t(e[r]).removeClass(n.rowConfig[i].cssClass);n.activeTable.selectRows()}}}),this.rowMSButton=new e.ui.MultiSplitButton({items:this.rowMSItems,name:"tableRowActions"}),this.rowMSItems.length>0&&i.addButton(this.name+".row",this.rowMSButton,s.t("floatingmenu.tab.table"),3)},c.initColumnBtns=function(){var n=this;i.addButton(this.name+".column",new e.ui.Button({name:"addcolumnleft",iconClass:"aloha-button aloha-button-addColumnLeft",size:"small",tooltip:s.t("button.addcolleft.tooltip"),onclick:function(){n.activeTable&&n.activeTable.addColumnsLeft()}}),s.t("floatingmenu.tab.table"),1),i.addButton(this.name+".column",new e.ui.Button({name:"addcolumnright",iconClass:"aloha-button aloha-button-addColumnRight",size:"small",tooltip:s.t("button.addcolright.tooltip"),onclick:function(){n.activeTable&&n.activeTable.addColumnsRight()}}),s.t("floatingmenu.tab.table"),1),i.addButton(this.name+".column",new e.ui.Button({name:"deletecolumns",iconClass:"aloha-button aloha-button-deleteColumns",size:"small",tooltip:s.t("button.delcols.tooltip"),onclick:function(){if(n.activeTable){var t=n.activeTable;e.showMessage(new e.Message({title:s.t("Table"),text:s.t("deletecolumns.confirm"),type:e.Message.Type.CONFIRM,callback:function(e){e=="yes"&&t.deleteColumns()}}))}}}),s.t("floatingmenu.tab.table"),1),this.columnHeader=new e.ui.Button({name:"columnheader",iconClass:"aloha-button aloha-button-col-header",size:"small",tooltip:s.t("button.columnheader.tooltip"),toggle:!0,onclick:function(){if(n.activeTable){var r=n.activeTable.selection.selectedColumnIdxs,i,s=n.activeTable.selection.isHeader();for(var o=0;o<n.activeTable.selection.selectedCells.length;o++)i=n.activeTable.selection.selectedCells[o],s?i=e.Markup.transformDomObject(i,"td").removeAttr("scope").get(0):i=e.Markup.transformDomObject(i,"th").attr("scope","row").get(0),t(n.activeTable.selection.selectedCells[o]).bind("mousedown",function(e){var n=t(this).children("div").eq(0);setTimeout(function(){n.trigger("focus")},1)});n.activeTable.refresh(),n.activeTable.selection.unselectCells(),n.activeTable.selection.selectColumns(r)}}}),i.addButton(this.name+".column",this.columnHeader,s.t("floatingmenu.tab.table"),1),this.btnTablemergecells=new e.ui.Button({name:"tablemergecells",iconClass:"aloha-button aloha-button-merge-cells",size:"small",tooltip:s.t("button.mergecells.tooltip"),toggle:!1,onclick:function(){n.activeTable&&n.activeTable.selection.mergeCells()}}),i.addButton(this.name+".column",this.btnTablemergecells,s.t("floatingmenu.tab.table"),1),this.btnTablesplitcells=new e.ui.Button({name:"tablesplitcells",iconClass:"aloha-button aloha-button-split-cells",size:"small",tooltip:s.t("button.splitcells.tooltip"),toggle:!1,onclick:function(){n.activeTable&&n.activeTable.selection.splitCells()}}),i.addButton(this.name+".column",this.btnTablesplitcells,s.t("floatingmenu.tab.table"),1),this.columnMSItems=[],t.each(this.columnConfig,function(e,r){var i={name:r.name,text:s.t(r.text),tooltip:s.t(r.tooltip),iconClass:"aloha-button aloha-column-layout "+r.iconClass,click:function(e,i,s){if(n.activeTable){var o=n.activeTable.selection.selectedCells;for(var u=0;u<o.length;u++)if(t(o[u]).attr("class").indexOf(r.cssClass)>-1)t(o[u]).removeClass(r.cssClass);else{t(o[u]).addClass(r.cssClass);for(var a=0;a<n.columnConfig.length;a++)n.columnConfig[a].cssClass!=r.cssClass&&t(o[u]).removeClass(n.columnConfig[a].cssClass)}n.activeTable.selectColumns()}}};n.columnMSItems.push(i)}),this.columnMSItems.length>0&&this.columnMSItems.push({name:"removeFormat",text:s.t("button.removeFormat.text"),tooltip:s.t("button.removeFormat.tooltip"),iconClass:"aloha-button aloha-button-removeFormat",wide:!0,click:function(){if(n.activeTable){var e=n.activeTable.selection.selectedCells;for(var r=0;r<e.length;r++)for(var i=0;i<n.columnConfig.length;i++)t(e[r]).removeClass(n.columnConfig[i].cssClass);n.activeTable.selectColumns()}}}),this.columnMSButton=new e.ui.MultiSplitButton({items:this.columnMSItems,name:"tableColumnActions"}),this.columnMSItems.length>0&&i.addButton(this.name+".column",this.columnMSButton,s.t("floatingmenu.tab.table"),3)},c.initTableButtons=function(){var n=this;i.createScope(this.name+".row","Aloha.global"),i.createScope(this.name+".column","Aloha.global"),i.createScope(this.name+".cell","Aloha.continuoustext"),this.createTableButton=new e.ui.Button({name:"table",iconClass:"aloha-button aloha-button-table",size:"small",tooltip:s.t("button.createtable.tooltip"),onclick:function(e,t){c.createDialog(e.btnEl.dom)}}),i.addButton("Aloha.continuoustext",this.createTableButton,o.t("floatingmenu.tab.insert"),1),this.initColumnBtns(),this.initRowsBtns(),this.tableMSItems=[];var r=this.tableConfig;t.each(r,function(e,t){n.tableMSItems.push({name:t.name,text:s.t(t.text),tooltip:s.t(t.tooltip),iconClass:"aloha-button aloha-table-layout "+t.iconClass,click:function(){if(n.activeTable){for(var e=0;e<r.length;e++)n.activeTable.obj.removeClass(r[e].cssClass);n.activeTable.obj.addClass(t.cssClass)}}})}),this.tableMSItems.length>0&&this.tableMSItems.push({name:"removeFormat",text:s.t("button.removeFormat.text"),tooltip:s.t("button.removeFormat.tooltip"),iconClass:"aloha-button aloha-button-removeFormat",wide:!0,click:function(){if(n.activeTable)for(var e=0;e<r.length;e++)n.activeTable.obj.removeClass(n.tableConfig[e].cssClass)}}),this.tableMSButton=new e.ui.MultiSplitButton({items:this.tableMSItems,name:"tableActions"}),this.tableMSItems.length>0&&i.addButton(this.name+".cell",this.tableMSButton,s.t("floatingmenu.tab.tablelayout"),3),this.btnMergecells=new e.ui.Button({name:"mergecells",iconClass:"aloha-button aloha-button-merge-cells",size:"small",tooltip:s.t("button.mergecells.tooltip"),toggle:!1,onclick:function(){n.activeTable&&n.activeTable.selection.mergeCells()}}),i.addButton(this.name+".cell",this.btnMergecells,s.t("floatingmenu.tab.table"),1),this.btnSplitcells=new e.ui.Button({name:"splitcells",iconClass:"aloha-button aloha-button-split-cells",size:"small",tooltip:s.t("button.splitcells.tooltip"),toggle:!1,onclick:function(){n.activeTable&&n.activeTable.selection.splitCells()}}),i.addButton(this.name+".cell",this.btnSplitcells,s.t("floatingmenu.tab.table"),1),this.captionButton=new e.ui.Button({name:"tablecaption",iconClass:"aloha-button aloha-button-table-caption",size:"small",tooltip:s.t("button.caption.tooltip"),toggle:!0,onclick:function(){if(n.activeTable)if(n.activeTable.obj.children("caption").is("caption"))n.activeTable.obj.children("caption").remove();else{var r=s.t("empty.caption"),i=t("<caption></caption>");n.activeTable.obj.append(i),n.makeCaptionEditable(i,r);var o=i.find("div").eq(0),u=o.contents().eq(0);if(u.length>0){var a=new l.Utils.RangeObject;a.startContainer=a.endContainer=u.get(0),a.startOffset=0,a.endOffset=u.text().length,n.activeTable.obj.find("div.aloha-table-cell-editable").blur(),o.focus(),a.select(),e.Selection.updateSelection()}}}}),i.addButton(this.name+".cell",this.captionButton,s.t("floatingmenu.tab.table"),1),this.summary=new e.ui.AttributeField({width:275,name:"tableSummary"}),this.summary.addListener("keyup",function(e,t){n.activeTable.checkWai()}),this.settings.summaryinsidebar||i.addButton(this.name+".cell",this.summary,s.t("floatingmenu.tab.table"),1)},c.makeCaptionEditable=function(e,n){var r=this,i=e.children("div").eq(0);i.length==0&&(i=t("<div></div>"),t(i).addClass("aloha-ui"),t(i).addClass("aloha-editable-caption"),e.contents().length>0?e.contents().wrap(i):(n&&i.text(n),e.append(i))),i.contentEditable(!0),i.unbind("mousedown"),i.bind("mousedown",function(e){return i.focus(),e.preventDefault(),e.stopPropagation(),!1})},c.createDialog=function(e){this.createLayer.set("target",e),this.createLayer.show()},c.createTable=function(n,r){if(this.preventNestedTables())return;if(e.activeEditable&&typeof e.activeEditable.obj!="undefined"){var i=document.createElement("table"),s=i.id=l.Utils.guid(),o=document.createElement("tbody");for(var u=0;u<r;u++){var f=document.createElement("tr");for(var h=0;h<n;h++){var p=document.createTextNode("Â "),d=document.createElement("td");d.appendChild(p),f.appendChild(d)}o.appendChild(f)}i.appendChild(o),v(e.Selection.getRangeObject(),i),l.Utils.Dom.insertIntoDOM(t(i),e.Selection.getRangeObject(),e.activeEditable.obj),m();var g=document.getElementById(s);if(!c.isWithinTable(g)){var y=new a(g,c);y.parentEditable=e.activeEditable,y.activate(),t.browser.msie?window.setTimeout(function(){y.cells[0].wrapper.get(0).focus()},20):y.cells[0].wrapper.get(0).focus(),c.TableRegistry.push(y)}c.checkForNestedTables(e.activeEditable.obj)}else this.error("There is no active Editable where the table can be				inserted!")},c.setFocusedTable=function(e){var t=this;null==e&&null!=this.activeTable&&this.activeTable.selection.unselectCells();for(var n=0;n<c.TableRegistry.length;n++)c.TableRegistry[n].hasFocus=!1;if(typeof e!="undefined"){this.summary.setTargetObject(e.obj,"summary");if(e.obj.children("caption").is("caption")){t.captionButton.setPressed(!0);var r=e.obj.children("caption");t.makeCaptionEditable(r)}e.hasFocus=!0}c.activeTable=e;if(this.tableMSButton.extButton){for(var n=0;n<this.tableMSItems.length;n++)this.tableMSButton.showItem(this.tableMSItems[n].name);this.tableMSButton.setActiveItem()}if(this.activeTable)for(var n=0;n<this.tableConfig.length;n++)this.activeTable.obj.hasClass(this.tableConfig[n].cssClass)&&this.tableMSButton.setActiveItem(this.tableConfig[n].name)},c.error=function(t){e.Log.error(this,t)},c.debug=function(t){e.Log.debug(this,t)},c.info=function(t){e.Log.info(this,t)},c.log=function(t){e.log("log",this,t)},c.get=function(e){return this.config[e]?this.config[e]:this.parameters[e]?this.parameters[e]:undefined},c.set=function(e,t){this.config[e]?this.config[e]=t:this.parameters[e]=t},c.makeClean=function(e){var t=this;e.find("table").each(function(){t.getTableFromRegistry(this)&&(new a(this,t)).deactivate()})},c.toString=function(){return this.prefix},c.updateFloatingMenuScope=function(){null!=c.activeTable&&null!=c.activeTable.selection.selectionType&&i.setScope(c.name+"."+c.activeTable.selection.selectionType)},r.register(c),c});